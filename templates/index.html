<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>AICommerce â€“ ×—×™×–×•×™ ×”×¦×œ×—×ª ××•×¦×¨×™×</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f4f6f9; margin:0; padding:20px; }
        .container { max-width: 1100px; margin: auto; }
        .card {
            background:white;
            padding:20px;
            border-radius:10px;
            margin-bottom:20px;
            box-shadow:0 2px 4px rgba(0,0,0,0.05);
        }
        h1,h2,h3 { margin-top:0; }
        input, textarea { width:100%; padding:8px; margin:5px 0 10px; box-sizing:border-box; }
        button {
            padding:10px 15px;
            background:#007bff;
            border:none;
            color:white;
            cursor:pointer;
            border-radius:5px;
        }
        button:hover { background:#0056b3; }
        table { width:100%; border-collapse:collapse; font-size:14px; }
        th, td { padding:6px 4px; text-align:right; border-bottom:1px solid #eee; }
        .top-bar { display:flex; justify-content:space-between; align-items:center; }
        .small { font-size:13px; color:#555; }
        a { color:#007bff; text-decoration:none; }
        a:hover { text-decoration:underline; }
        .tag-high { background:#d4edda; color:#155724; padding:2px 6px; border-radius:4px; }
        .tag-mid  { background:#fff3cd; color:#856404; padding:2px 6px; border-radius:4px; }
        .tag-low  { background:#f8d7da; color:#721c24; padding:2px 6px; border-radius:4px; }
        .error { color:#c00; }
        .winner { background:#e3fcec; }
        .row { display:flex; flex-wrap:wrap; gap:20px; }
        .col { flex:1 1 0; min-width:260px; }
        code { background:#f1f1f1; padding:2px 4px; border-radius:3px; }
        pre { background:#f8f9fb; padding:10px; border-radius:6px; overflow-x:auto; }
        #api-key-value { direction:ltr; font-family:monospace; }
    </style>
</head>
<body>
<div class="container">

    <!-- ×›×•×ª×¨×ª + ×¡×˜×˜×•×¡ ××©×ª××© -->
    <div class="card">
        <div class="top-bar">
            <div>
                <h1>AICommerce â€“ ×—×™×–×•×™ ×”×¦×œ×—×ª ××•×¦×¨×™×</h1>
                <div class="small">
                    ××©×ª××©: {{ user.email }}<br>
                    ×× ×•×™: {{ user.plan }}
                    {% if user.plan == "FREE" %}
                        â€“ ×©×™××•×©×™× ×”×™×•×: {{ used_today }}/{{ limit_today }}
                    {% endif %}
                </div>
            </div>
            <div class="small" style="text-align:left;">
                <a href="{{ url_for('shop') }}">ğŸ›’ ×—× ×•×ª ×“××•</a><br>
                <a href="{{ url_for('logout') }}">×”×ª× ×ª×§×•×ª</a><br>
                <a href="{{ url_for('forgot_password') }}">×©×—×–×•×¨ ×¡×™×¡××”</a><br>
                {% if user.plan == "FREE" %}
                    <a href="{{ url_for('upgrade') }}">×©×“×¨×•×’ ×œ-PRO (×“××•)</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ×¡×˜×˜×•×¡ ××•×“×œ -->
    <div class="card">
        <h2>×¡×˜×˜×•×¡ ××•×“×œ AI</h2>
        {% if has_model %}
            <p>âœ… ××•×“×œ ML ×¤×¢×™×œ.</p>
            {% if model_info %}
                <p class="small">
                    RÂ²: {{ model_info.r2_test|round(3) }} |
                    MAE: {{ model_info.mae_test|round(2) }} |
                    ×“×’×™××•×ª ××™××•×Ÿ: {{ model_info.n_samples }}<br>
                    ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”: {{ model_info.trained_at }}
                </p>
            {% endif %}
        {% else %}
            <p>âš ï¸ ×›×¨×’×¢ ××™×Ÿ ××•×“×œ ML ×××•××Ÿ â€“ ×”×—×™×–×•×™ ××‘×•×¡×¡ ×¢×œ ×˜×¨× ×“ + ××—×™×¨ (MVP).</p>
            <p class="small">
                ××¤×©×¨ ×œ×××Ÿ ×‘×—×™× × ×¢×œ ×”×“××˜×” ×©× ××¡×£ (×¦×¨×™×š ×œ×¤×—×•×ª 20 ×“×•×’×××•×ª). ××™××•×Ÿ ××•×˜×•××˜×™ ×™×¨×•×¥ ×‘×¨×§×¢ ×›×©××ª×•×•×¡×¤×™× × ×ª×•× ×™× ×—×“×©×™×.
            </p>
        {% endif %}
        {% if train_message %}
            <p class="small"><strong>{{ train_message }}</strong></p>
        {% endif %}
        <form method="POST" action="{{ url_for('train_model_route') }}">
            <button type="submit">×××Ÿ ××•×“×œ ML ×—×™× ××™ ×¢×›×©×™×•</button>
        </form>
    </div>

    <!-- ×˜×•×¤×¡ ××•×¦×¨ ×‘×•×“×“ -->
    <div class="card">
        <h2>×—×™×–×•×™ ×œ××•×¦×¨ ×—×“×©</h2>

        {% if result and result.error %}
            <p class="error"><strong>{{ result.error }}</strong></p>
        {% endif %}

        <form method="POST" action="{{ url_for('predict') }}">
            <label>×©× ××•×¦×¨:</label>
            <input type="text" name="name" required>

            <label>×§×˜×’×•×¨×™×”:</label>
            <input type="text" name="category" placeholder="×˜×›× ×•×œ×•×’×™×”, ×›×•×©×¨, ×‘×™×ª, ..." required>

            <label>××—×™×¨ (â‚ª):</label>
            <input type="number" name="price" step="0.01" required>

            <label>×¦×™×•×Ÿ ×˜×¨× ×“ (0â€“100):</label>
            {% if has_pytrends %}
                <input type="text" name="trend_score" placeholder="××• ×›×ª×•×‘ auto ×›×“×™ ×œ××©×•×š ×-Google Trends">
            {% else %}
                <input type="number" name="trend_score" min="0" max="100" step="1" required>
            {% endif %}

            <button type="submit">×—×©×‘ Success Score</button>
        </form>

        {% if result and not result.error %}
            <hr>
            <h3>×ª×•×¦××” ××—×¨×•× ×”:</h3>
            <p><strong>×©×:</strong> {{ result.name }}</p>
            <p><strong>×§×˜×’×•×¨×™×”:</strong> {{ result.category }}</p>
            <p><strong>××—×™×¨:</strong> {{ result.price }} â‚ª</p>
            <p>
                <strong>×˜×¨× ×“:</strong> {{ result.trend_score }}
                {% if result.trend_source == "google" %}
                    (Google Trends / Fallback)
                {% endif %}
            </p>
            <p><strong>Success Score:</strong> {{ result.success_score }}</p>
            <p>
                <strong>×¨××ª ×¡×™×›×•×Ÿ:</strong>
                {% if result.risk == "×¤×•×˜× ×¦×™××œ ×’×‘×•×”" %}
                    <span class="tag-high">{{ result.risk }}</span>
                {% elif result.risk == "×‘×™× ×•× ×™" %}
                    <span class="tag-mid">{{ result.risk }}</span>
                {% else %}
                    <span class="tag-low">{{ result.risk }}</span>
                {% endif %}
            </p>
            {% if result.model_source %}
                <p class="small">××§×•×¨ ×—×™×–×•×™: {{ '××•×“×œ ML ×××•××Ÿ' if result.model_source == 'ml' else '×—×•×§×™ MVP' }}</p>
            {% endif %}
        {% endif %}
    </div>

    <!-- ×˜×•×¤×¡ ×”×©×•×•××ª ×©× ×™ ××•×¦×¨×™× -->
    <div class="card">
        <h2>×”×©×•×•××ª ×©× ×™ ××•×¦×¨×™× ×œ×¤× ×™ ×”×©×§×”</h2>
        <form method="POST" action="{{ url_for('compare') }}">
            <div class="row">
                <div class="col">
                    <h3>××•×¦×¨ 1</h3>
                    <label>×©×:</label>
                    <input type="text" name="c_name1" required>

                    <label>×§×˜×’×•×¨×™×”:</label>
                    <input type="text" name="c_category1" required>

                    <label>××—×™×¨ (â‚ª):</label>
                    <input type="number" name="c_price1" step="0.01" required>

                    <label>×˜×¨× ×“ (0â€“100 ××• auto):</label>
                    {% if has_pytrends %}
                        <input type="text" name="c_trend1" placeholder="××¡×¤×¨ ××• auto">
                    {% else %}
                        <input type="number" name="c_trend1" min="0" max="100" step="1" required>
                    {% endif %}
                </div>

                <div class="col">
                    <h3>××•×¦×¨ 2</h3>
                    <label>×©×:</label>
                    <input type="text" name="c_name2" required>

                    <label>×§×˜×’×•×¨×™×”:</label>
                    <input type="text" name="c_category2" required>

                    <label>××—×™×¨ (â‚ª):</label>
                    <input type="number" name="c_price2" step="0.01" required>

                    <label>×˜×¨× ×“ (0â€“100 ××• auto):</label>
                    {% if has_pytrends %}
                        <input type="text" name="c_trend2" placeholder="××¡×¤×¨ ××• auto">
                    {% else %}
                        <input type="number" name="c_trend2" min="0" max="100" step="1" required>
                    {% endif %}
                </div>
            </div>

            <button type="submit">×”×©×•×•×” ×‘×™×Ÿ ×”××•×¦×¨×™×</button>
        </form>

        {% if compare_result %}
            <hr>
            <h3>×ª×•×¦××•×ª ×”×©×•×•××”</h3>
            <p><strong>×”××œ×¦×”:</strong>
                {% if compare_result.winner == "p1" %}
                    ××•××œ×¥ ×™×•×ª×¨: <strong>{{ compare_result.p1.name }}</strong>
                {% elif compare_result.winner == "p2" %}
                    ××•××œ×¥ ×™×•×ª×¨: <strong>{{ compare_result.p2.name }}</strong>
                {% else %}
                    ×©× ×™ ×”××•×¦×¨×™× ×“×•××™× â€“ ××™×Ÿ ×× ×¦×— ×‘×¨×•×¨.
                {% endif %}
            </p>
            <p>{{ compare_result.reason }}</p>

            <table>
                <thead>
                <tr>
                    <th>××•×¦×¨</th>
                    <th>×§×˜×’×•×¨×™×”</th>
                    <th>××—×™×¨</th>
                    <th>×˜×¨× ×“</th>
                    <th>Success</th>
                    <th>×¡×™×›×•×Ÿ</th>
                </tr>
                </thead>
                <tbody>
                <tr class="{% if compare_result.winner == 'p1' %}winner{% endif %}">
                    <td>{{ compare_result.p1.name }}</td>
                    <td>{{ compare_result.p1.category }}</td>
                    <td>{{ compare_result.p1.price }}</td>
                    <td>{{ compare_result.p1.trend_score }}</td>
                    <td>{{ compare_result.p1.success_score }}</td>
                    <td>{{ compare_result.p1.risk }}</td>
                </tr>
                <tr class="{% if compare_result.winner == 'p2' %}winner{% endif %}">
                    <td>{{ compare_result.p2.name }}</td>
                    <td>{{ compare_result.p2.category }}</td>
                    <td>{{ compare_result.p2.price }}</td>
                    <td>{{ compare_result.p2.trend_score }}</td>
                    <td>{{ compare_result.p2.success_score }}</td>
                    <td>{{ compare_result.p2.risk }}</td>
                </tr>
                </tbody>
            </table>
        {% endif %}
    </div>

    <!-- ×“×©×‘×•×¨×“ -->
    <div class="row">
        <div class="col">
            <div class="card">
                <h2>×”×™×¡×˜×•×¨×™×™×ª ×ª×—×–×™×•×ª (×—×™× ×)</h2>
                <p class="small">20 ×”×ª×—×–×™×•×ª ×”××—×¨×•× ×•×ª ×©×œ×š â€“ ×›×•×œ×œ ×§×™×©×•×¨ ×œ×™×™×¦×•× CSV.</p>
                <p class="small"><a href="{{ url_for('export_history') }}">â¬‡ï¸ ×”×•×¨×“×ª ×”×™×¡×˜×•×¨×™×” ×‘-CSV</a></p>
                {% if history %}
                    <table>
                        <thead>
                        <tr>
                            <th>××•×¦×¨</th>
                            <th>×§×˜×’×•×¨×™×”</th>
                            <th>××—×™×¨</th>
                            <th>Success</th>
                            <th>×¡×™×›×•×Ÿ</th>
                            <th>× ×•×¦×¨</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for row in history %}
                            <tr>
                                <td>{{ row.name }}</td>
                                <td>{{ row.category }}</td>
                                <td>{{ row.price }}</td>
                                <td>{{ row.success_score }}</td>
                                <td>{{ row.risk }}</td>
                                <td>{{ row.created_at }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="small">××™×Ÿ ×¢×“×™×™×Ÿ ×ª×—×–×™×•×ª â€“ ×‘×¦×¢ ×—×™×–×•×™ ×¨××©×•×Ÿ ×›×“×™ ×œ×‘× ×•×ª ×“××˜×”.</p>
                {% endif %}
            </div>
        </div>

        {% if dashboard %}
        <div class="col">
            <div class="card">
                <h2>×ª×•×‘× ×•×ª ××”×“××˜×” ×”×›×œ×œ×™</h2>
                <p><strong>×××•×¦×¢ Success ×›×œ×œ×™:</strong> {{ dashboard.overall_mean|round(1) }}</p>

                <h3>×××•×¦×¢ Success ×œ×¤×™ ×§×˜×’×•×¨×™×”:</h3>
                <ul>
                    {% for row in dashboard.per_category %}
                        <li>{{ row.category }} â€“ {{ row.mean_score|round(1) }}</li>
                    {% endfor %}
                </ul>

                <p><strong>×§×˜×’×•×¨×™×” ×—×–×§×”:</strong>
                    {{ dashboard.best_category.category }}
                    ({{ dashboard.best_category.mean_score|round(1) }})</p>

                <p><strong>×§×˜×’×•×¨×™×” ×—×œ×©×”:</strong>
                    {{ dashboard.worst_category.category }}
                    ({{ dashboard.worst_category.mean_score|round(1) }})</p>

                <h3>××•×¦×¨ ×”×›×™ ×—×–×§:</h3>
                <p>
                    {{ dashboard.best_product.name }} â€“
                    ×§×˜×’×•×¨×™×”: {{ dashboard.best_product.category }},
                    Success: {{ dashboard.best_product.success_score|round(1) }},
                    ×¡×™×›×•×Ÿ: {{ dashboard.best_product.risk }}
                </p>

                <h3>××•×¦×¨ ×”×›×™ ×—×œ×©:</h3>
                <p>
                    {{ dashboard.worst_product.name }} â€“
                    ×§×˜×’×•×¨×™×”: {{ dashboard.worst_product.category }},
                    Success: {{ dashboard.worst_product.success_score|round(1) }},
                    ×¡×™×›×•×Ÿ: {{ dashboard.worst_product.risk }}
                </p>
            </div>
        </div>
        {% endif %}
    </div>

    {% if user_insights %}
    <div class="card">
        <h2>×ª×•×‘× ×•×ª ××™×©×™×•×ª ×¢×‘×•×¨×š</h2>
        <p><strong>×××•×¦×¢ Success ××™×©×™:</strong> {{ user_insights.mean_score|round(1) }}</p>
        <p><strong>××•×¦×¨ ×× ×¦×—:</strong> {{ user_insights.best_product.name }} ({{ user_insights.best_product.success_score|round(1) }})</p>
        <p><strong>××•×¦×¨ ×©×¦×¨×™×š ×—×™×–×•×§:</strong> {{ user_insights.worst_product.name }} ({{ user_insights.worst_product.success_score|round(1) }})</p>

        {% if user_insights.per_category %}
        <h3>×”×§×˜×’×•×¨×™×•×ª ×©×¢×•×‘×“×•×ª ×œ×š ×”×›×™ ×˜×•×‘</h3>
        <ul>
            {% for cat in user_insights.per_category %}
                <li>{{ cat.category }} â€“ ×××•×¦×¢ {{ cat.mean_score|round(1) }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}

    {% if free_ideas %}
    <div class="card">
        <h2>×¨×¢×™×•× ×•×ª ×—×™× ××™×™× ×œ×”×¤×¢×œ×” ××™×™×“×™×ª</h2>
        <div class="row">
            {% for idea in free_ideas %}
            <div class="col" style="min-width:220px;">
                <div style="background:#f8f9fb; padding:10px; border-radius:8px; height:100%;">
                    {% if idea.image %}
                        <img src="{{ idea.image }}" alt="{{ idea.name }}" style="width:100%; border-radius:6px; margin-bottom:8px;">
                    {% endif %}
                    <strong>{{ idea.name }}</strong><br>
                    ×§×˜×’×•×¨×™×”: {{ idea.category }}<br>
                    ××—×™×¨ ×™×¢×“: {{ idea.price }} â‚ª<br>
                    ×˜×¨× ×“: {{ idea.trend_score }} | Success: {{ idea.success_score }}<br>
                    ×¡×™×›×•×Ÿ: {{ idea.risk }}<br>
                    <span class="small">{{ idea.description }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>
</body>
</html>

